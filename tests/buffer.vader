Given buf:
  first line
  2nd line
  3rd line

Execute("Register buffer with initial lines"):
  let buffer = bufnr('%')

  let init_lines = ['a', 'b']
  call comrade#buffer#Register(buffer, 42, init_lines)

  let btype = getbufvar(buffer, '&buftype')
  AssertEqual 'acwrite', btype
  AssertEqual 42, comrade#bvar#get(buffer, 'channel')
  AssertEqual init_lines, nvim_buf_get_lines(buffer, 0, -1, v:true)
  AssertEqual 0, getbufvar(buffer, '&modified')
  Assert !comrade#jetbrain#IsChannelExisting(42)
  " Write current buffer
  AssertThrows execute("w")

  let btype = getbufvar(buffer, '&buftype')
  AssertEqual '', btype

Given buf:
  first line

Execute("Register buffer without initial lines"):
  let buffer = bufnr('%')

  execute('w!')
  AssertEqual 0, getbufvar(buffer, '&modified')

  call comrade#buffer#Register(buffer, 42, v:false)

  let btype = getbufvar(buffer, '&buftype')
  AssertEqual 'acwrite', btype

  AssertEqual 42, comrade#bvar#get(buffer, 'channel')
  AssertEqual ['first line'], nvim_buf_get_lines(buffer, 0, -1, v:true)
  AssertEqual 0, getbufvar(buffer, '&modified')

Given buf:
  first line

Execute("Reload buffer, should be unregistered"):
  let buffer = bufnr('%')

  call comrade#buffer#Register(buffer, 42, v:false)
  let map = comrade#bvar#all(buffer)
  Assert !empty(map)

  execute('e!')
  Assert empty(map)

Given buf:
  new

" This test doesn't really work. No idea how to create a new buffer in vader.
Execute("Reload a new buffer, unregistered should be no problem"):
  let buffer = bufnr('%')
  call comrade#buffer#Unregister(buffer)
